name: å‘å¸ƒåˆ° PyPI

on:
  # å½“æ¨é€ tag æ—¶è§¦å‘ï¼ˆç”¨äºæ­£å¼å‘å¸ƒï¼‰
  push:
    tags:
      - 'v*'
  
  # æ‰‹åŠ¨è§¦å‘ï¼ˆç”¨äºæµ‹è¯•å’Œçµæ´»å‘å¸ƒï¼‰
  workflow_dispatch:
    inputs:
      environment:
        description: 'å‘å¸ƒç¯å¢ƒ'
        required: true
        default: 'pypi'
        type: choice
        options:
        - pypi
      version:
        description: 'ç‰ˆæœ¬å· (å¯é€‰ï¼Œç•™ç©ºåˆ™ä½¿ç”¨å½“å‰ç‰ˆæœ¬)'
        required: false
        type: string

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥å’Œæµ‹è¯•
  quality-check:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10", "3.11", "3.12"]
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½® Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pytest pytest-asyncio black isort mypy
        pip install langchain-openai  # ç”¨äºæµ‹è¯•
    
    - name: ä»£ç æ ¼å¼æ£€æŸ¥
      run: |
        black --check shouldpy/
        isort --check-only shouldpy/
    
    - name: ç±»å‹æ£€æŸ¥
      run: |
        mypy shouldpy/ --ignore-missing-imports
    
    - name: åŸºç¡€å¯¼å…¥æµ‹è¯•
      run: |
        python -c "from shouldpy import should; print('Import successful!')"
    
    - name: è¿è¡Œæµ‹è¯•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      run: |
        if [ -d "tests" ]; then
          pytest tests/ -v
        else
          echo "No tests directory found, skipping tests"
        fi

  # æ„å»ºåŒ…
  build:
    needs: quality-check
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äºç‰ˆæœ¬æ ‡ç­¾
    
    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.12"
    
    - name: å®‰è£…æ„å»ºå·¥å…·
      run: |
        python -m pip install --upgrade pip
        pip install build twine
    
    - name: æ›´æ–°ç‰ˆæœ¬å· (å¦‚æœæ‰‹åŠ¨æŒ‡å®š)
      if: github.event.inputs.version != ''
      run: |
        # æ›´æ–° pyproject.toml ä¸­çš„ç‰ˆæœ¬å·
        sed -i 's/version = "[^"]*"/version = "${{ github.event.inputs.version }}"/' pyproject.toml
        # æ›´æ–° __init__.py ä¸­çš„ç‰ˆæœ¬å·  
        sed -i 's/__version__ = "[^"]*"/__version__ = "${{ github.event.inputs.version }}"/' shouldpy/__init__.py
    
    - name: æ„å»ºåŒ…
      run: |
        python -m build
    
    - name: æ£€æŸ¥åŒ…å®Œæ•´æ€§
      run: |
        twine check dist/*
    
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: python-package-distributions
        path: dist/

  # å‘å¸ƒåˆ°æ­£å¼ PyPI
  publish-pypi:
    needs: build
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v'))
    
    permissions:
      id-token: write  # ç”¨äº OIDC èº«ä»½éªŒè¯
    
    steps:
    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: python-package-distributions
        path: dist/
    
    - name: å‘å¸ƒåˆ° PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        verbose: true
    
    - name: å‘å¸ƒé€šçŸ¥
      run: |
        echo "ğŸ‰ æˆåŠŸå‘å¸ƒåˆ° PyPI!"
        echo "ğŸ“¦ å®‰è£…å‘½ä»¤: pip install shouldpy"

  # åˆ›å»º GitHub Release
  create-release:
    needs: [build, publish-pypi]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    
    permissions:
      contents: write
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: python-package-distributions
        path: dist/
    
    - name: æå–ç‰ˆæœ¬å·
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
    
    - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜
      id: release_notes
      run: |
        VERSION=${{ steps.version.outputs.version }}
        
        # ä» CHANGELOG.md æå–å½“å‰ç‰ˆæœ¬çš„å˜æ›´è®°å½•
        if [ -f "CHANGELOG.md" ]; then
          # æå–å½“å‰ç‰ˆæœ¬çš„å˜æ›´è®°å½•
          CHANGES=$(awk "/## \[$VERSION\]/ {flag=1; next} /## \[/ && flag {exit} flag" CHANGELOG.md)
          if [ -n "$CHANGES" ]; then
            echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "RELEASE_NOTES=å‘å¸ƒç‰ˆæœ¬ $VERSION" >> $GITHUB_OUTPUT
          fi
        else
          echo "RELEASE_NOTES=å‘å¸ƒç‰ˆæœ¬ $VERSION" >> $GITHUB_OUTPUT
        fi
    
    - name: åˆ›å»º GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        name: ç‰ˆæœ¬ ${{ steps.version.outputs.version }}
        body: |
          ## ğŸ‰ shouldpy ${{ steps.version.outputs.version }} å‘å¸ƒ

          ${{ steps.release_notes.outputs.RELEASE_NOTES }}

          ## ğŸ“¦ å®‰è£…æ–¹å¼
          ```bash
          pip install shouldpy==${{ steps.version.outputs.version }}
          ```

          ## ğŸ”— é“¾æ¥
          - [PyPI é¡µé¢](https://pypi.org/project/shouldpy/${{ steps.version.outputs.version }}/)
          - [æ–‡æ¡£](https://github.com/zhixiangxue/should-ai#readme)
          - [æ›´æ–°æ—¥å¿—](https://github.com/zhixiangxue/should-ai/blob/main/CHANGELOG.md)
        draft: false
        prerelease: ${{ contains(github.ref, 'rc') }}
        files: |
          dist/shouldpy-${{ steps.version.outputs.version }}-py3-none-any.whl
          dist/shouldpy-${{ steps.version.outputs.version }}.tar.gz